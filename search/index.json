[{"content":"快速理解网络协议（三）MAC 层 总览 物理层 Physical Layer 虽然 TCP/IP 模型不涉及硬件设备所在的物理层，但还是在这里简单介绍下物理层。1\n物理层，顾名思义，表示实际的物理链接。物理层利用物理传输介质为通信的两端建立链接，实现比特流的传输，如铜线、光缆或无线通道，保证比特流正确的传输到对端。常见设备包括中继器、集线器等。其中集线器 Hub，完全在物理层工作，会将自己收到的每一个字节，都复制到其他端口上去，即广播模式。\nMAC 层 Link Layer 链路层，又称 MAC 层。MAC 的全称为 Medium Access Control，即媒体访问控制，主要有两个功能，寻址和控制。\n寻址，即如何找到数据包接收方 控制，即谁先发、谁后发，发送出现问题如何处理 解决“控制”问题 在以太网中，两个节点间传输的数据最终都会转换成电信号，在物理传输介质上发送出去。物理传输介质肯定是共享的，在发送数据时需要考虑谁先发、谁后发、同时发送时怎么避免冲突、出现问题怎么处理等。**这就是多路访问问题，即如何协调多个发送和接收节点对单一共享广播信道的访问。**计算机网络使用多路访问协议来规范它们在共享的广播信道上的传输行为。\n多路访问协议 我们可以先来思考一下，理想情况下在共享信道上期望怎么传输数据。\n如果只有一个节点需要发送数据，那么我们期望它可以以整个信道的速率 R 发送数据 如果有 M 个节点需要同时发送数据，那么我们期望它可以以（信道的传输速率 R / M）来发送数据 规划车道 ➡️ 信道划分协议 Channel Partitioning Protocol\n采用多路复用技术，将链路、网络资源（如带宽）划分为“资源片”，将“资源片”分配给各路通信，每路通信独占其分配到的资源片进行通信。这样的划分方式，可以满足理想情况 2。\n依次排队 ➡️ 轮转协议 Taking-turns Protocol\n多个节点轮流发送数据。当只有一个结点活跃时，以信道的全部发送速率 R 发送；当有M个结点活跃时，每个活跃结点的吞吐量接近 R/M。完全满足理想情况 1，几乎满足理想情况 2。\n随机应变 ➡️ 随机访问协议 Random Access Protocol\n节点总是以信道的全部速率发送数据，传输时可能且允许出现冲突。当检测到冲突时通过延时重传等方式恢复，**这也是以太网使用的方式。**完全满足理想情况 1，几乎满足理想情况 2。\n在轮转协议和随机访问协议中，好像都可以满足理想情况。那为什么以太网使用的说随机访问协议而不是轮转协议呢？主要有以下三个原因\n网络架构更简单，所有设备都可以同时发送和接收数据，不需要等待其他设备的轮转时机 更加灵活和高效，随机访问协议允许多个设备同时发送数据，不需要进行时间调度或协调 可扩展性高，新设备可以随时连接到网络，并立即开始发送和接收数据，不需要调度或配置 解决“寻址”问题 MAC 地址是指网络设备的硬件地址，是由网络设备的制造商烧录在设备的网卡中的一个全球唯一的地址，如果一台设备有多个网卡，则每个网卡都需要并会有一个唯一的 MAC 地址。MAC 地址共 48 位（6个字节），以十六进制表示。\n当数据传输时，源设备会根据目标设备的 MAC 地址 “寻址” ，确保数据能够被正确地传送到目标设备。当设备接收到数据后，如果发现目的地址与本地 MAC 地址不一致，则会丢弃，只有真正的目标设备才会接收并处理收到的数据。\nMAC 地址是一个局域网（LAN）范围内的地址，它只在局域网中起作用，不能直接进行跨网络通信。在局域网中，可以通过交换机（Switch）来完成数据的传输。交换机通过学习和记录连接到它的设备的 MAC 地址，根据 MAC 地址来决定数据的转发。而在互联网中，数据通常是通过路由器（Router）等设备进行转发，而不是根据 MAC 地址进行直接传输。\n以太网帧 - Frame 以太网帧 Ethernet frame 是 MAC 层传输数据的基本单位。其中 MAC 头部包含 目标 MAC 地址、源 MAC 地址 和 类型。类型标识了传输数据的封装协议2。常见的类型有，0x0800 表示 IPv4 数据报，0x0806 表示 ARP 数据报，0x86DD 表示 IPv6 数据报3。\nframe 目标 MAC 地址：表示数据包应该被发送到哪个网络设备，由 6 个字节组成 源 MAC 地址：表示数据包是从哪个网络设备发送的，同样由 6 个字节组成 类型：表示数据包类型，0800 表示 IP 数据包，0806 表示 ARP 数据包 数据：实际的数据内容，长度可变 CRC：Cyclic Redundancy Check 循环冗余检测，通过 XOR 异或的算法，计算整个数据包在发送的过程中是否出现了错误 获取 MAC 地址 在网络通信中，使用 MAC 地址直接进行通信是不可行的，我们借助 IP 地址作为中间桥梁来实现通信。在局域网中，知道了要发送的 IP 地址，该如何获得目标设备的 MAC 地址呢？\n每个设备的网卡的 MAC 地址都是固定的，我们可以手动一个个添加局域网中其他设备的 MAC 地址，随着局域网中的主机越来越多，这种方式难以为继。我们需要自动获取、更新和维护各个设备的 MAC 地址，这就是 Address Resolution Protocol。\nARP 协议，工作在 MAC 层，用于获得已知 IP 地址的 MAC 地址。而手动配置 MAC 地址的方式，一般是出于安全考虑，为了防止非法用户访问，由网络管理员手动在 MAC 地址表中添加合法用户的 MAC 地址表项，当手动配置的数量比较大时，难以人工维护，可以使用端口安全功能实现 MAC 地址和接口的动态绑定。\n具体的 ARP 协议内容，我们下节继续～\n小测验 在物理层工作的常见设备有哪些？ 在 MAC 层工作的常见设备有哪些？ MAC 层传输数据的基本是什么？它的头的格式是什么？每个字段的含义和作用是什么？ 如何通过 IP 地址获取 MAC 地址？ 有些文章描述 TCP/IP 模型有五层，其中包括了物理层 Physical Layer。但在 RFC 1122 中未指定物理层，我还是倾向于四层。详情可参考：https://datatracker.ietf.org/doc/html/rfc1122#page-8\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n以太网II帧：https://en.wikipedia.org/wiki/Ethernet_frame#Ethernet_II\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n更多类型含义：https://en.wikipedia.org/wiki/EtherType#Values\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","date":"2023-08-23T17:16:32+08:00","permalink":"https://boxtsecond.github.io/2023/%E5%BF%AB%E9%80%9F%E7%90%86%E8%A7%A3%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E4%B8%89mac-%E5%B1%82/","title":"快速理解网络协议（三）MAC 层"},{"content":" 总览 TCP/IP 协议模型 TCP/IP 协议模型 我们从下往上依次介绍这些层级，有一个很重要的原因是，在网络中传输的数据包，会按照这些层级来封装报文，一个数据包只可能有下层没上层，绝不会有上层没下层（这句话要牢牢记住）。\n层级 作用 在此层的协议 链路层 负责节点之间数据的传输控制和寻址 ATM, PPP 等 网络层 负责数据包的路由和转发 IP, ICMP, OSPF 等 传输层 负责数据端到端之间的具体传输行为控制 TCP, UDP 等 应用层 负责不同应用使用的通信协议的数据封装 HTTP, SMTP, FTP, DNS, SSH 等 链路层 链路层负责节点之间数据的传输控制和寻址，重点在于控制和寻址。控制，即谁先发，谁后发，发送时出现问题如何处理，寻址，即如何找到数据包的接收方。\n解决 “控制” 问题\n网络中的链路分为两种类型，点对点链路 和 广播链路。点对点链路，由链路一端的单个发送方和链路另一端的单个接收方组成，如 点对点协议（PPP，Point-to-Point Protocol）、高级数据链路控制（HDLC，High-level Data Link Control）。广播链路，能够让多个发送和接收节点都连接到相同的、单一的、共享的广播信道上。很明显，在点对点链路中，由于只有两个节点参与通信，因此不需要进行数据传输的控制，“控制“ 主要解决的问题是如何协调多个发送和接收节点对单一共享广播信道的访问，即**多路访问问题。**为了解决多路访问问题，于是出现了多路访问控制协议，Multiple Access Control 简称 MAC。\n常见的多路访问协议\n信道划分协议 Channel Partitioning Protocol 采用多路复用技术，将链路、网络资源（如带宽）划分为“资源片”，将“资源片”分配给各路通信，每路通信独占其分配到的资源片进行通信 轮转协议 Taking-turns Protocol 多个节点轮流发送数据 当只有一个结点活跃时，以信道的全部发送速率 R 发送；当有M个结点活跃时，每个活跃结点的吞吐量接近 R/M 随机访问协议 Random Access Protocol 以信道的全部速率发送数据，检测到冲突时通过延时重传等方式恢复 以太网使用的方式 解决 “寻址” 问题\n这里要用到一个物理地址，叫作链路层地址，或 MAC 地址。MAC 地址用于在网络中唯一标示一个网卡（并不是设备），一台设备若有一或多个网卡，则每个网卡都需要并会有一个唯一的 MAC 地址。\n在此层的头部一般被称为 MAC 头。具体格式如下图橙色部分\nMAC 头 目标 MAC 地址：表示数据包应该被发送到哪个网络设备，由 6 个字节组成 源 MAC 地址：表示数据包是从哪个网络设备发送的，同样由 6 个字节组成 类型：表示数据包类型，0800 表示 IP 数据包，0806 表示 ARP 数据包 数据：实际的数据内容，长度可变 CRC：Cyclic Redundancy Check 循环冗余检测，通过 XOR 异或的算法，计算整个数据包在发送的过程中是否出现了错误 网络层 网络层负责数据包的路由和转发，重点在于路由，即选择合适的路径转发到目标主机。\n网络层使用 IP 协议来提供基本的数据传输服务，包括数据包的路由、分组和转发等功能。IP 协议使用 IP 地址唯一标识网络中的设备。\nIP 地址主要有两个作用\n定位，即提供设备网络中的“位置”信息 路由，即数据包选择什么 “路径” 到达目标设备 在此层的头部一般被称为 IP 头。IPv4 头具体格式如图所示\nIPv4 头 IPv4 头\n版本：指定 IP 协议的版本，4 表示 IPv4，占用 4 bits 首部长度 IHL：表示 IP 头的长度，占用 4 bits 区分服务：用于标识网络中不同类型的数据流，只有在使用区分服务时，此字段才有作用，占用 6 bits 显示拥塞通告：可选功能，在两端都支持且底层网络支持时可被使用，占用 2 bits 全长：IP 数据报总长度，包括 IP 首部和 IP 数据部分的长度，占用 16 bits 标识符：唯一标识一个 IP 数据报的所有分片，占用 16 bits 标志：用于控制和识别报文的分片，占用 3 bits 分片偏移：用于标识每个分片相对于原始报文开头的偏移量，占用 13 bits 生存时间：用于防止 IP 数据报在网络中无限循环，作为跳数计数器，每经过一个路由都会减 1，为0时，将丢弃该数据报，占用 8 bits 协议：表示 IP 数据报中使用的上层协议类型，例如 TCP、UDP 等，占用 8 bits 首部校验和：用于检验 IP 首部（不包括数据部分）在传输过程中是否有错，占用 16 bits 源地址：IP 数据报的源地址 目的地址：IP 数据报的目的地址 选项：其他附加信息，首部长度必须是 32 的倍数，若不满足则填充 EOL（0x00），直至满足 传输层 传输层负责数据端到端之间的具体传输行为控制，重点在于端到端和传送控制。端到端，即将数据具体送达至哪个程序，传送控制，即如何将数据送达到目的地。\n传输层上有两个最重要也最常见的协议，TCP 和 UDP，用于端到端的数据传输控制。这两块的内容比较复杂和重要，后面会专门拿出来单独说明，在此就先不赘述了。\n应用层 应用层负责不同应用使用的通信协议的数据封装，重点在于通信协议的数据封装，即在通信时按照哪种格式如何封装数据。\n应用层上的协议是和我们日常开发息息相关的，比如程序使用 HTTP 协议发送一个 HTTP 请求、使用 SMTP 协议向客户发送一封邮件等等。在应用层上，每个协议的封装和解析是协议特有的，HTTP 协议的数据不能被 SMTP 协议解析。\n分层的原因 任何复杂、大型的工程都需要分层来实现模块化，用来降低不同模块之间耦合度，提高模块之间的可替代性和整个工程的复杂度。分层带来的优点有以下几个方面：\n降低不同层级、模块之间的耦合度，提高网络的灵活性。每层的功能和任务清晰且明确，可以分别设计和实现，使得单一协议或模块的开发、维护、升级变得更加容易。 提高相同层级内模块的可替代性。比如 DNS 协议，既可以使用 TCP 协议又可以使用 UDP 协议作为传输层协议。 更低的层级可以统一的向上提供服务，比如传输层的 TCP 协议可以为应用层的 HTTP、FTP 协议等提供服务。 促进了层级和模块的标准化，使得网络在技术和商业上更加开放和透明。 在日常的开发设计中，我们也要将这种分层的思想融入到自己开发的系统中。\n模块化或分层：将系统按照不同的功能和职责进行分层，使系统的各个部分职责清晰、功能单一、易于维护和扩展。 标准化：遵循接口规范，对不同层之间的数据传输进行约束和规范，从而提高系统的稳定性、可靠性和可维护性。 可替代性：通过定义接口和协议来约束不同层之间的数据传输，降低模块间的耦合度，提高模块的可替代性。 小测验 TCP/IP 协议模型有几层，它们的作用分别是什么？ 在网络中的数据包，有没有可能有 TCP 头，但是没有 IP 头？如果有的话，举例说明。 在网络中的数据包，有没有可能有 TCP 头，但是没有 HTTP 头？如果有的话，举例说明。 ","date":"2023-08-23T14:52:03+08:00","permalink":"https://boxtsecond.github.io/2023/%E5%BF%AB%E9%80%9F%E7%90%86%E8%A7%A3%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E4%BA%8Ctcp/ip-%E5%8D%8F%E8%AE%AE%E6%A8%A1%E5%9E%8B/","title":"快速理解网络协议（二）TCP/IP 协议模型"},{"content":"快速理解网络协议（一），基础知识的补充\n总览 IP 地址 IP 地址中的 “IP” 代表Internet Protocol（互联网协议），IP 地址是在 IP 协议下使用的地址，IP 地址有三个主要功能：标识设备或网络、定位和选择路由。由于 IPv4 是第一个架构中的主要版本，所以在没有特殊说明的时候，IP 地址一般指的是 IPv4 地址。\nIPv4 地址 一个 IPv4 地址被 “.” 分割成 4 个部分，每个部分 8 个 bit，总共 32 位，使用十进制表示。在设计之初，IPv4 地址被分成 5 类，如下图所示，我们平时接触到的基本是 ABC 三类。一个 IPv4 地址被分为两部分，网络号 + 主机号，这种地址分类的方式叫做分类网络。\nIPv4地址分类 在分类网络中，A、B、C 三类的 IPv4 地址的数量分割一点都不合理，范围跨度太大了。随着互联网的快速发展，CIDR 取代了分类网络。\nCIDR （Classless Inter-Domain Routing ）无类别域间路由，旨在重新划分地址空间，将地址块可以较为自由合理的分配给用户。\nCIDR（“/” 后带着数字这种表示形式，“/” 后）将 32 位的 IP 地址一分为二，网络号 + 主机号，例如 100.100.100.2/24，前 24 位是网络号，后 8 位是主机号 网络号全为 1 的就是子网掩码，主机号全为 1 的就是广播地址 将子网掩码和 IP 地址按位计算 AND，可以得到网络号，即可以判断一个 IP 地址是不是在当前子网内 示例： 100.100.100.2/24\n子网掩码：255.255.255.0 广播地址：100.100.100.255，所有 100.100.100 网络里面的机器都可以收到 100.100.100.20 与子网掩码做按位与运算，得到 100.100.100.0，即为网络号 易错计算： 求 16.158.165.91/22 的网络号、第一个地址、子网掩码和广播地址\n16.158.165.91/22 → 16.158. 101001/01. 01011011 网络号：16.158. 101001/00.0 → 16.158.164.0 第一个地址：16.158.164.1 子网掩码：255.255.252.0 广播地址：16.158.167.255 常见特殊 IPv4 地址 127.0.0.1 表示本机地址 0.0.0.0 有两种含义，默认路由地址和通配符地址。默认路由地址我们之后再说。通配符地址指的是，若进程监听了通配符地址，那么进程监听了本机上的所有 IP 地址 IPv6 地址 由于互联网的快速兴起，导致 IPv4 地址很快就不够用了，于是出现了 IPv6 地址。一个 IPv6 地址被 “:” 分为 8 个部分，每个部分以 4 位十六进制方式表示，总共 128 位。比如：2001:0db8:85a3:08d3:1319:8a2e:0370:734。\nIPv6 地址和 IPv4 地址相似，也使用网络号 + 主机号的形式划分。一个 IPv4 地址可以很容易的转换成一个 IPv6 地址，如果一个地址是 IPv4 地址，可以直接表示成，::ffff:IPv4地址，比如 ::ffff:192.168.89.9，这种格式叫做**IPv4映射地址。**而::1 类似于 IPv4 中的 127.0.0.1。\nIP 地址的功能 标识设备或网络、定位，提供设备在网络中的位置信息 选择路由，在网络传输中，通过 IP 地址选择路由 MAC 地址 和 IP 地址相似，由于此地址作用于 MAC 层，所以称之为 MAC 地址。MAC 地址是指网络设备的硬件地址，是由网络设备的制造商烧录在设备的网卡中的一个全球唯一的地址。类比现实生活的话，IP 地址更像是精确到门牌号的地址信息，而 MAC 地址则是拥有唯一身份证号的“人”。\nIP 地址 和 MAC 地址的区别 区别 IP地址 MAC地址 地址类型 逻辑地址 物理地址 分配方式 由运营商分配 由设备制造商烧录到设备的网卡中 作用范围 全球互联网上的通信 局域网内通信 主要功能 标识设备和选择路由 唯一标识设备 查看 IP 地址、MAC 地址 Linux 下使用 ip addr 或 ifconfig，Windows 下使用 ipconfig\nifconfig “1” 表示 MAC 地址，是一个网卡的物理地址，使用十六进制，6个 byte表示 “2” 表示 net_device flags，网络设备的状态标识 BROADCAST 表示此网卡有广播地址，可以发送广播包 MULTICAST 表示此网卡可以发送多播包 UP 表示此网卡处于启动状态 LOWER_UP 表示 L1 启动，即网线已插入 mtu 1500 表示最大传输单元 MTU 为 1500，是以太网的默认值，即正文部分不允许超过 1500 个字节 qdisc，表示 queueing discipline 排队规则，内核通过网络接口发送数据包时，需要按照 qdisc 配置的规则把数据包加入队列 mq，是一个虚拟 qdisc，目的是为网络设备的每个硬件队列创建一个 pfifo_fast 队列 pfifo，不对数据包做任何处理，先入先出 pfifo_fast，数据包按照服务类型 TOS Type Of Service（ IP 头中的一个字段）分配到不同的波段中，每个波段对应的优先级不同 小测验 如何判断一个 IP 地址是否在子网内？ IP 地址是逻辑地址还是物理地址？它在网络中的作用是什么？ IP 地址和 MAC 地址的区别？ MAC 地址是逻辑地址还是物理地址？它在网络中的作用是什么？ ","date":"2023-08-23T14:52:03+08:00","permalink":"https://boxtsecond.github.io/2023/%E5%BF%AB%E9%80%9F%E7%90%86%E8%A7%A3%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E4%B8%80-ip-%E5%9C%B0%E5%9D%80mac-%E5%9C%B0%E5%9D%80/","title":"快速理解网络协议（一） IP 地址、MAC 地址"}]